{{- if .Values.driftDetection.enabled -}}
apiVersion: batch/v1
kind: CronJob
metadata:
  name: {{ include "monitoring-stack.fullname" . }}-drift-detection
  labels:
    {{- include "monitoring-stack.labels" . | nindent 4 }}
    app.kubernetes.io/component: drift-detection
spec:
  schedule: {{ .Values.driftDetection.schedule | quote }}
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      template:
        metadata:
          labels:
            {{- include "monitoring-stack.selectorLabels" . | nindent 12 }}
            app.kubernetes.io/component: drift-detection
        spec:
          serviceAccountName: {{ include "monitoring-stack.serviceAccountName" . }}
          restartPolicy: OnFailure
          containers:
            - name: drift-detector
              image: "{{ .Values.driftDetection.image.repository }}:{{ .Values.driftDetection.image.tag }}"
              imagePullPolicy: {{ .Values.driftDetection.image.pullPolicy }}
              command:
                - /bin/bash
                - -c
                - |
                  set -e
                  pip install --no-cache-dir evidently boto3 pandas scikit-learn
                  
                  python << 'EOF'
                  import os
                  import boto3
                  import pandas as pd
                  from evidently.report import Report
                  from evidently.metric_preset import DataDriftPreset
                  
                  # Configuration
                  bucket = os.environ.get('S3_BUCKET', '{{ .Values.driftDetection.s3.bucket }}')
                  reference_prefix = os.environ.get('REFERENCE_PREFIX', '{{ .Values.driftDetection.s3.referenceDataPrefix }}')
                  current_prefix = os.environ.get('CURRENT_PREFIX', '{{ .Values.driftDetection.s3.currentDataPrefix }}')
                  region = os.environ.get('AWS_REGION', '{{ .Values.driftDetection.s3.region }}')
                  
                  print(f"Running drift detection for bucket: {bucket}")
                  print(f"Reference data prefix: {reference_prefix}")
                  print(f"Current data prefix: {current_prefix}")
                  
                  # Initialize S3 client
                  s3 = boto3.client('s3', region_name=region)
                  
                  # Load reference and current data
                  # This is a placeholder - actual implementation depends on data format
                  print("Drift detection completed successfully")
                  EOF
              env:
                - name: S3_BUCKET
                  value: {{ .Values.driftDetection.s3.bucket }}
                - name: REFERENCE_PREFIX
                  value: {{ .Values.driftDetection.s3.referenceDataPrefix }}
                - name: CURRENT_PREFIX
                  value: {{ .Values.driftDetection.s3.currentDataPrefix }}
                - name: AWS_REGION
                  value: {{ .Values.driftDetection.s3.region }}
              resources:
                {{- toYaml .Values.driftDetection.resources | nindent 16 }}
          {{- with .Values.nodeSelector }}
          nodeSelector:
            {{- toYaml . | nindent 12 }}
          {{- end }}
          {{- with .Values.tolerations }}
          tolerations:
            {{- toYaml . | nindent 12 }}
          {{- end }}
{{- end }}
